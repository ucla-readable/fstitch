#!/bin/bash

BENCHDIR="`dirname "$0"`"
. $BENCHDIR/common
KUDOSDIR="$BENCHDIR/.."

function usage () {
	echo "About: Generate javascript table data for a given test and measurement"
	echo "Usage: `basename "$0"` <-m MEASUREMENT> <-t TESTNAME> <-o OUTDIR>"
	echo "       where MEASUREMENT is one of time, space, or io"
}

while getopts "m:t:o:" flag; do
	case "$flag" in
		m) MEASUREMENT="$OPTARG";;
		t) TESTNAME="$OPTARG";;
		o) OUTDIR="$OPTARG";;
		/?) usage 1>&2; exit 1;;
		*) usage 1>&2; exit 1;;
	esac
done

if [ -z "$MEASUREMENT" ]; then
	usage 1>&2
	exit 1
fi

if [ -z "$OUTDIR" ]; then
	usage 1>&2
	exit 1
fi
if [ ! -d "$OUTDIR" ]; then
	echo "OUTDIR $OUTDIR does not exist" 1>&2
	exit 1
fi

function most_recent_test () {
	REV=0
	MR=
	for test in `ls -t $KUDOSDIR/tests/`; do
		DIR="$KUDOSDIR/tests/$test"
		REVN=`cat $DIR/svnversion | sed -r 's/:[0-9]+//;s/M$//'`
		[ $REVN -le $REV ] && continue
		if [ "`cat $DIR/host`" == "$HOST" ] && [ "`cat $KUDOSDIR/tests/$test/diskcache`" == "$DISKCACHE" ] && [ "`cat $DIR/fs`" == "$FS" ] && [ "`cat $DIR/consistency_mode`" == "$CMODE" ] && [ "`cat $KUDOSDIR/tests/$test/app_consistency_mode`" == "$ACMODE" ] && [ -f $DIR/$TESTNAME.run.0 ]; then
			MR="$test"
			REV=$REVN
		fi
	done
	echo "$MR"
}

ARRAYNAME="${MEASUREMENT}_${TESTNAME}_data"
JSFILE="$OUTDIR/${MEASUREMENT}_${TESTNAME}.js"

echo "var $ARRAYNAME = new Array();" > $JSFILE
I=0
for sys in "kudos safe ext2 su opgroup" "kudos safe ext2 meta opgroup" "kudos safe ext2 full opgroup" "kudos safe ext2 none opgroup" "linux unsafe ext2 none fsync" "linux unsafe ext3 ordered fsync" "linux unsafe ext3 journal fsync"; do
	HOST=`echo "$sys" | awk '{print $1}'`
	DISKCACHE=`echo "$sys" | awk '{print $2}'`
	FS=`echo "$sys" | awk '{print $3}'`
	CMODE=`echo "$sys" | awk '{print $4}'`
	ACMODE=`echo "$sys" | awk '{print $5}'`
	RECENT="`most_recent_test`"

	[ -z "$RECENT" ] && echo "No data for $HOST $DISKCACHE $FS $CMODE $ACMODE $TESTNAME" && continue
	REV="`cat $KUDOSDIR/tests/$RECENT/svnversion`"

	#echo "Most recent for $HOST $FS $CMODE $TESTNAME is $RECENT"
	DATA="`$BENCHDIR/ex_${MEASUREMENT} -d $KUDOSDIR/tests/$RECENT -t $TESTNAME | sed 's/\([0-9]\) /\1, /g;s/, *$//'`"
	[ -z "$DATA" ] && echo "No data for $HOST $FS $CMODE $TESTNAME" && continue
	echo "${ARRAYNAME}[$I] = new Array(\"$HOST\", \"$FS\", \"$CMODE\", \"$REV\", ${DATA});" >> $JSFILE
	I=$((I+1))
done
