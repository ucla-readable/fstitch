EXTRA_CFLAGS += -I$(src)/..
EXTRA_CFLAGS += -DKFSD

GCC_VERSION := $(call cc-version)
ifeq ($(shell echo $(GCC_VERSION) -ge 0400),1)
	EXTRA_CFLAGS += -Wno-declaration-after-statement
endif

kfsobjrel = ../obj/kernel
kfsobj = $(src)/$(kfsobjrel)

obj-m += kkfsd.o

KKFSD_LIB_OBJS := \
              kdprintf.o \
              memdup.o \
              qsort.o \
              vector.o \
              hash_map.o \
              hash_set.o \
              kfs_feature.o \
              svnrevtol.o \
              sleep.o

KKFSD_KFS_OBJS := \
              kfsd.o \
              kfsd_init.o \
              debug.o \
              kernel_serve.o \
              bdesc.o \
              blockman.o \
              chdesc.o \
              chdesc_util.o \
              revision.o \
              barrier.o \
              modman.o \
              opgroup.o \
              devfs_cfs.o \
              mem_bd.o \
              md_bd.o \
              elevator_cache_bd.o \
              block_resizer_bd.o \
              barrier_resizer_bd.o \
              partition_bd.o \
              pc_ptable.o \
              bsd_ptable.o \
              mirror_bd.o \
              wt_cache_bd.o \
              wb_cache_bd.o \
              journal_bd.o \
              loop_bd.o \
              josfs_base.o \
              ufs_base.o \
              ufs_common.o \
              ufs_alloc_linear.o \
              ufs_dirent_linear.o \
              ufs_super_wb.o \
              opgroup_lfs.o \
              wholedisk_lfs.o \
              uhfs.o \
              file_hiding_cfs.o \
              sched.o \
              sync.o

kkfsd-objs := $(addprefix $(kfsobjrel)/,$(KKFSD_LIB_OBJS)) \
		$(addprefix $(kfsobjrel)/,$(KKFSD_KFS_OBJS))

$(addprefix $(kfsobj)/,$(KKFSD_LIB_OBJS)): $(kfsobj)/%.o : $(src)/../lib/%.c
	@test -d $(kfsobj)/kernel || mkdir -p $(kfsobj)/kernel
	$(call cmd,force_checksrc)
	$(call if_changed_rule,cc_o_c)

$(addprefix $(kfsobj)/,$(KKFSD_KFS_OBJS)): $(kfsobj)/%.o : $(src)/%.c
	@test -d $(kfsobj)/kernel || mkdir -p $(kfsobj)/kernel
	$(call cmd,force_checksrc)
	$(call if_changed_rule,cc_o_c)
